import{I as j,u as w,b as c,r as u,at as W,j as t,au as v}from"./index-DZZwBIMF.js";import{c as D,s as R}from"./notificationWebSocket-LyXQ8B2b.js";import{T as f,B as p}from"./Box-L8YP_HMF.js";import{T as C}from"./ThemeProvider-BnVlN9RE.js";import{P as T}from"./List-CtAuu3yH.js";import{D as _}from"./Divider-Bp6PTbT_.js";import{T as M}from"./TextField-_N8teEsA.js";import{B as N}from"./Button-Ll0b2T1T.js";import"./dividerClasses-eAm5yYW3.js";let s=null,g=0;const B=5,S=(r,n,i)=>s?(console.warn("WebSocket already connected."),s):(s=new WebSocket(`ws://localhost:8000/ws/chat/${r}/?token=${i}`),s.onopen=()=>{console.log("WebSocket connection established."),g=0},s.onmessage=a=>{try{const o=JSON.parse(a.data);if(console.log("Received data:",o),o.error)console.error("WebSocket error:",o.error);else if(o.message){const l=o.message.content||Object.values(o.message).join(""),d={...o.message,content:l,timestamp:o.message.timestamp||new Date().toISOString(),sender:o.message.sender||{id:o.user_id,name:o.full_name}};console.log("Processed message:",d),n(d)}}catch(o){console.error("Failed to parse WebSocket message:",o)}},s.onerror=a=>{console.error("WebSocket error:",a)},s.onclose=a=>{console.log("WebSocket connection closed:",a),g<B?setTimeout(()=>{g++,S(r,n,i)},5e3):console.error("Max reconnect attempts reached. Could not reconnect.")},s),E=r=>{s&&s.readyState===WebSocket.OPEN?(s.send(JSON.stringify(r)),console.log("Message sent:",r)):console.warn("WebSocket is not open. Message not sent.")},O=()=>{s&&(s.close(),s=null,console.log("WebSocket connection closed."))},P=j({palette:{primary:{main:"#00796b"},secondary:{main:"#b2dfdb"}},typography:{fontFamily:"Roboto, sans-serif"}}),Y=()=>{const r=w(),n=c(e=>e.chat.currentChatRoom),i=c(e=>e.chat.messages),a=c(e=>e.auth.accessToken),o=c(e=>e.auth.user),[l,d]=u.useState(""),x=u.useRef(null),m=c(e=>e.auth.userid),b=c(e=>e.auth.full_name);u.useEffect(()=>{if(n&&a)return r(W(n.id)),S(n.id,e=>{const h=e.id?e:{...e,id:`temp-${Date.now()}`};r(v(h))},a),D(a,m,r),()=>{O()}},[r,n,a]),u.useEffect(()=>{var e;(e=x.current)==null||e.scrollIntoView({behavior:"smooth"})},[i]);const k=e=>{if(e.preventDefault(),l.trim()){const h={type:"chat_message",message:l,user_id:m,full_name:b,timestamp:new Date().toISOString()};E(h),`${b}`,n.id,R(),d("")}};if(!n)return t.jsx(f,{children:"Select a chat room"});const y=n.jobseeker.id===o.id?n.employer:n.jobseeker;return t.jsx(C,{theme:P,children:t.jsxs(p,{sx:{display:"flex",flexDirection:"column",height:"80vh",maxWidth:"800px",width:"100%",margin:"0 auto",padding:2,backgroundColor:"#f5f5f5",borderRadius:2,boxShadow:2},children:[t.jsxs(f,{variant:"h5",gutterBottom:!0,children:["Chat with ",y.full_name]}),t.jsxs(p,{sx:{flexGrow:1,overflowY:"auto",mb:2,border:"1px solid #ddd",borderRadius:1,p:2,backgroundColor:"#fafafa",display:"flex",flexDirection:"column"},children:[i.map(e=>t.jsxs(T,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:e.sender.id===m?"#e3f2fd":"#f1f8e9",alignSelf:e.sender.id===m?"flex-end":"flex-start",maxWidth:"75%",wordBreak:"break-word"},children:[t.jsxs(f,{variant:"body2",gutterBottom:!0,children:[t.jsxs("strong",{children:[e.sender.full_name||`${e.sender.name}`,":"]})," ",e.content||"No content"]}),t.jsx(f,{variant:"caption",color:"textSecondary",children:new Date(e.timestamp).toLocaleString()})]},e.id||`temp-${e.timestamp}`)),t.jsx("div",{ref:x})]}),t.jsx(_,{sx:{mb:2}}),t.jsxs(p,{component:"form",onSubmit:k,sx:{display:"flex"},children:[t.jsx(M,{fullWidth:!0,variant:"outlined",size:"small",value:l,onChange:e=>d(e.target.value),placeholder:"Type a message...",sx:{mr:1}}),t.jsx(N,{type:"submit",variant:"contained",color:"primary",size:"small",children:"Send"})]})]})})};export{Y as default};
